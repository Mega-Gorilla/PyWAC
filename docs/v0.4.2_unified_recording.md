# PyWAC v0.4.2 Unified Recording Implementation

## Overview

Version 0.4.2 introduces a **unified recording architecture** that consolidates all recording modes into a single, flexible core function. This eliminates redundancy and provides a cleaner, more maintainable API while maintaining 100% backward compatibility.

## Key Improvements

### 1. Single Core Function
All recording operations now flow through one unified function:

```python
def record(
    duration: float,
    target: Optional[Union[str, int]] = None,
    output_file: Optional[str] = None,
    on_complete: Optional[Callable[[AudioData], None]] = None,
    fallback_enabled: bool = True
) -> Union[AudioData, bool, None]
```

### 2. Intelligent Return Types
The function adapts its return type based on usage:
- **AudioData**: When recording to memory
- **bool**: When saving to file (success/failure)
- **None**: When using async callback

### 3. Flexible Target Selection
- `target=None`: System-wide recording
- `target="process_name"`: Record specific application
- `target=pid`: Record by process ID

### 4. Improved Process Discovery
The system now uses a two-tier lookup strategy:
1. First checks process loopback list
2. Falls back to audio sessions if not found

This ensures maximum compatibility across different Windows configurations.

## API Examples

### Simple System Recording
```python
import pywac

# Record 5 seconds of system audio
audio = pywac.record_audio(5)
audio.save("system.wav")
```

### Process-Specific Recording
```python
from pywac.unified_recording import record

# Record Firefox audio by name
audio = record(duration=10, target="firefox")

# Record by PID
audio = record(duration=10, target=1234)

# Save directly to file
success = record(duration=10, target="spotify", output_file="spotify.wav")
```

### Asynchronous Recording
```python
def handle_audio(audio_data):
    print(f"Received {audio_data.duration:.1f}s of audio")
    audio_data.save("async_recording.wav")

# Start async recording
record(duration=5, on_complete=handle_audio)
```

### Using the Recorder Class
```python
from pywac.unified_recording import Recorder

# Create a recorder for Firefox
recorder = Recorder(target="firefox")

if recorder.is_available():
    # Synchronous recording
    audio = recorder.record(5)
    
    # Direct to file
    recorder.record_to_file(5, "firefox.wav")
    
    # Asynchronous
    recorder.record_async(5, handle_audio)
```

## Architecture Benefits

### Before (v0.4.1)
- Three separate implementations for system/process/callback recording
- Duplicate code in `record_audio()`, `record_process()`, `record_with_callback()`
- Inconsistent parameter naming
- Limited flexibility

### After (v0.4.2)
- Single unified implementation
- DRY principle applied throughout
- Consistent, intuitive naming:
  - `process` → `target` (more flexible)
  - `filename` → `output_file` (clearer purpose)
  - `callback` → `on_complete` (better semantics)
- Easy to extend with new features

## Backward Compatibility

All existing APIs continue to work exactly as before:

```python
# These all still work
pywac.record_audio(5)
pywac.record_to_file("out.wav", 5)
pywac.record_process("firefox", "firefox.wav", 5)
pywac.record_process_id(1234, "app.wav", 5)
pywac.record_with_callback(5, callback_func)
```

## Performance

- No performance regression
- Event-driven capture (v0.4.1) still active
- CPU usage remains < 1%
- Zero-copy audio pipeline maintained

## Testing

Comprehensive test suite (`test_unified_recording.py`) validates:
- ✅ System recording (all modes)
- ✅ Process recording by name
- ✅ Process recording by PID
- ✅ File output
- ✅ Async callbacks
- ✅ Recorder class interface
- ✅ Convenience functions
- ✅ Full backward compatibility

## Migration Guide

No migration required! Existing code continues to work. However, for new code, consider using the unified API:

### Old Way
```python
# Three different functions for similar tasks
audio = pywac.record_audio(5)
pywac.record_process("firefox", "out.wav", 5)
pywac.record_with_callback(5, callback)
```

### New Way (Optional)
```python
# One function, multiple modes
audio = record(5)
record(5, target="firefox", output_file="out.wav")
record(5, on_complete=callback)
```

## Technical Details

### File Structure
```
pywac/
├── unified_recording.py  # Core unified implementation
├── api.py               # Public API (refactored to use unified core)
└── audio_data.py        # AudioData class
```

### Key Components
1. **`record()` function**: Core unified recording implementation
2. **`Recorder` class**: Object-oriented interface
3. **`_get_target_pid()`**: Smart process resolution with fallback
4. **`_capture_audio()`**: Low-level capture using process_loopback_queue

## Summary

Version 0.4.2 successfully unifies all recording modes into a single, elegant implementation while maintaining full backward compatibility. This makes PyWAC easier to use, maintain, and extend.

### Key Achievements
- ✅ Unified recording architecture
- ✅ Improved process discovery
- ✅ Cleaner, more intuitive API
- ✅ 100% backward compatibility
- ✅ Comprehensive test coverage
- ✅ Better variable naming conventions

### Version Comparison

| Version | Architecture | Features | Issues |
|---------|-------------|----------|--------|
| v0.3.x | Polling-based | Basic recording | High CPU (30-100%) |
| v0.4.0 | Queue-based | Thread-safe, adaptive | Moderate CPU (3-5%) |
| v0.4.1 | Event-driven | SetEventHandle support | None (CPU < 1%) |
| **v0.4.2** | **Unified** | **Single core API** | **None** |

PyWAC v0.4.2 represents the culmination of the recording API evolution, providing a clean, efficient, and user-friendly interface for Windows audio capture.