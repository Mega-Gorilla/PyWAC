# Migration Guide: v0.4.0 â†’ v0.4.1

## Overview

PyWAC v0.4.1 is a **performance release** with no breaking changes. The update is fully backward compatible and requires no code changes.

## What's New

### Automatic Event-Driven Capture
The `process_loopback_queue` module now automatically uses WASAPI's SetEventHandle API for efficient event-driven capture when available.

### Performance Improvements
- **CPU Usage**: Reduced from 3-5% to < 1%
- **Efficiency**: Zero polling when events are available
- **Compatibility**: Automatic fallback to polling mode

## No Migration Required

v0.4.1 is a drop-in replacement for v0.4.0. Simply update the package:

```bash
pip install --upgrade pywac
```

## Verifying Event-Driven Mode

To check if event-driven mode is active:

```python
import process_loopback_queue as queue_module

capture = queue_module.QueueBasedProcessCapture()
capture.start(process_id)

# Check metrics after capturing
metrics = capture.get_metrics()
if metrics['event_driven']:
    print(f"Event-driven mode active!")
    print(f"Event signals: {metrics['event_signals']}")
    print(f"Timeouts: {metrics['timeouts']}")
else:
    print("Running in polling mode")
```

## New Metrics

The `get_metrics()` method now includes:
- `event_driven`: Boolean indicating mode
- `event_signals`: Number of audio events received
- `timeouts`: Number of wait timeouts

## Console Output

The capture thread now reports its mode:
```
Capture thread started (event-driven mode), chunk size: 480 frames
```

or

```
Capture thread started (polling mode), chunk size: 480 frames
```

## Compatibility Notes

### Systems Supporting Event-Driven Mode
- Windows 10 version 2004 or later
- Process Loopback API available
- Audio device supporting event notifications

### Automatic Fallback
If event-driven initialization fails, the system automatically falls back to polling mode with no user intervention required.

## Performance Comparison

### CPU Usage
- **v0.4.0**: 3-5% (1ms polling)
- **v0.4.1**: < 1% (event-driven)

### Example Test Results
```
Mode: EVENT-DRIVEN
Event Signals: 499
Timeouts: 0
Events/Second: 99.8
Event Efficiency: 100.0%
```

## No Code Changes Required

All existing v0.4.0 code works without modification:

```python
# This code works identically in v0.4.0 and v0.4.1
from pywac.queue_streaming import QueueBasedStreamingCapture

capture = QueueBasedStreamingCapture(
    process_id=spotify_pid,
    on_audio=callback_func
)
capture.start()
# ... capture audio ...
audio = capture.stop()
```

## Summary

v0.4.1 is a performance optimization release that:
- Requires **no code changes**
- Provides **automatic performance improvements**
- Maintains **100% backward compatibility**
- Achieves **optimal CPU efficiency** (< 1%)

Simply upgrade and enjoy the performance benefits!